BIN_DIR = ../bin
LIB_DIR = ../lib
EXAMPLES_DIR = ../examples

DEL_DIR := $(shell ls $(EXAMPLES_DIR)/*/*.c) 
FILES := $(DEL_DIR:%.c=%)
EXAMPLES_AUX := $(shell ls $(EXAMPLES_DIR)/*/*.con)
EXAMPLES_FILES := $(EXAMPLES_AUX:%.con=%)
EXAMPLES_FILES_C := $(EXAMPLES_FILES:%=%.c)

CC = @CC@
# Use only one of the next two flags
OPTIMIZE =
#DEBUG = -g
CFLAGS = @CFLAGS@ 
INCPATH = ../include
LIBS = -lfl
YACC = yacc
LEX = @LEX@
AR = ar
ARFLAGS = -rc

DIR = `ls -d ../examples/*`

#
#############################################################
EXECUTABLE = 	netcomp
EXEC_OBJS  = 	netcomp_yacc.o \
		netcomp_lex.o 

LIBRARY    =	libnet_conn.a
LIB_OBJS   = 	mae_control.o \
		mae_control_main_true.o \
		mae_control_file_cb.o \
		io_display.o \
		mae_control_actions_cb.o \
		global.o \
		syn_neu.o \
		learning.o \
		connect.o \
		io.o \
		filter.o \
		user_functions.o \
		interpreter_yacc.o \
		interpreter_lex.o 

#############################################################
#

.c.o:
	$(CC) $(CFLAGS) -Wall -c -I$(INCPATH) -o $@ $*.c

.l.o:
	$(LEX) $*.l
	$(CC) $(CFLAGS) -c -I$(INCPATH) -o $@ lex.yy.c

.y.o:
	$(YACC) -d $*.y
	$(CC) $(CFLAGS) -c -I$(INCPATH) -o $@ y.tab.c
	mv y.tab.h $*.tab.h


#

build: $(LIBRARY) $(EXECUTABLE) libGA.a libtsai.a
	@echo OK
	
$(LIBRARY)	: $(LIB_OBJS) libGA.a
	$(AR) $(ARFLAGS) $(LIB_DIR)/$(LIBRARY) $(LIB_OBJS)
	ranlib $(LIB_DIR)/$(LIBRARY)

$(EXECUTABLE)	: $(EXEC_OBJS)
	$(CC) $(CFLAGS) -o $(BIN_DIR)/$(EXECUTABLE) $(EXEC_OBJS) $(LIBS)

libGA.a:
	$(MAKE) -C libga100
	cp  libga100/libGA.a $(LIB_DIR)

libtsai.a:
	$(MAKE) -C libtsai
	cp  libtsai/libTsai.a $(LIB_DIR)
	
#
##############################################################

mae_control.o 			: $(INCPATH)/mae_control.h
mae_control_main_true.o 	: $(INCPATH)/mae_control.h $(INCPATH)/mae.h
mae_control_file_cb.o 		: $(INCPATH)/mae_control.h $(INCPATH)/mae.h
mae_control_actions_cb.o 	: $(INCPATH)/mae_control.h $(INCPATH)/mae.h
global.o 			: $(INCPATH)/mae.h
syn_neu.o 			: $(INCPATH)/mae.h
learning.o 			: $(INCPATH)/mae.h
connect.o 			: $(INCPATH)/mae.h
io_display.o	 		: $(INCPATH)/mae.h
io.o 				: $(INCPATH)/mae.h
filter.o 			: $(INCPATH)/mae.h $(INCPATH)/filter.h
gabor_filters.o 		: $(INCPATH)/mae.h $(INCPATH)/filter.h
user_functions.o 		: $(INCPATH)/mae.h
netcomp_yacc.o 			: netcomp_yacc.y $(INCPATH)/mae.h
netcomp_lex.o 			: netcomp_lex.l netcomp_yacc.y $(INCPATH)/mae.h
interpreter_yacc.o 		: interpreter_yacc.y $(INCPATH)/mae.h 
interpreter_lex.o 		: interpreter_lex.l interpreter_yacc.y $(INCPATH)/mae.h

#
#############################################################
#

clean :
	rm -f *.o *yacc.c *lex.c *.bak *.tab.* lex.yy.c $(BIN_DIR)/$(EXECUTABLE) $(LIB_DIR)/$(LIBRARY) $(LIB_DIR)/libGA.a core
	rm -f ../examples/*/*.o ../examples/*/*/*.o ../examples/*/core ../examples/*/*.out 
	rm -f $(EXAMPLES_FILES_C)
	rm -f $(EXAMPLES_FILES)
	$(MAKE) clean -C libga100
	$(MAKE) clean -C libtsai

